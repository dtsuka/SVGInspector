# SVG Inspector -- 仕様書（draft）

- バージョン: 0.1  
- 最終更新日: 2025-11-20  
- 対象環境: Visual Studio Code 最新安定版 / TypeScript で実装

## 概要

SVG Inspector は、VS Code 上で SVG ファイルを専用ビューとして開き、  
オブジェクト構造を可視化しつつ属性編集を行える拡張機能である。

この拡張は VS Code の **Custom Editor** と **Webview** を利用し、  
SVG のレイヤー管理・プレビュー・属性編集をシームレスに提供する。  
テキストエディタでは把握しづらい複雑な SVG を、  
デザインツールに近い操作感で編集できることを目指す。

## 目的

- サイトに埋め込む用途に適した **余計な属性を付与しない純粋な編集** を行えること  
- SVG 内の各オブジェクト（`<g>`, `<path>`, `<rect>` など）に  
  `id` や `class` などの属性を簡単に追加・編集できるようにすること  
- GUI で構造を理解しやすくし、Web 制作の効率を向上させること  
- 既存の SVG を壊さない形で編集できるようにし、  
  余計な最適化や整形を行わないこと（差分が追いやすいこと）

## 想定ユーザー

- Web フロントエンドエンジニア  
- デザイナー / マークアップエンジニアで、VS Code を利用しているユーザー

## 主な機能

### 1. SVG 専用ビューの提供

- SVG ファイル（`*.svg`）を開くと、デフォルトのテキストビューではなく  
  専用エディタ（Webview）が表示される。  
- 必要に応じて「テキストで開く」に切り替えられること  
  （VS Code の標準挙動に準拠）。

### 2. レイアウト構成

| 左パネル | プレビュー（中央）     | 右パネル |
| ------- | ---------------------- | -------- |
| レイヤー | SVG 表示 + 操作エリア | 属性編集 |

#### 左パネル: レイヤーツリー

- SVG XML の階層構造をツリー表示（`<svg>` 直下〜末端要素まで）  
- 要素をクリックすると中央プレビュー上の該当要素が選択状態になる  
- 中央プレビューで要素をクリックした場合も、  
  ツリー内の該当ノードをハイライトして同期する  
- 非表示 / ロックなどの管理機能は **MVP 範囲外**（必要になれば別途仕様化）

#### 中央: プレビュー

- SVG を Webview 内でレンダリングして表示  
- 要素クリックで選択  
- マウスホイール / ジェスチャによる拡大・縮小（panzoom 利用を想定）  
- ドラッグによるパン  
- チェックボックスなどの UI で背景色を切り替え  
  （例: チェッカーボード / 白 / 黒）

#### 右パネル: 属性編集

- 選択中の要素の属性を一覧表示・編集  
- 代表的な属性:
  - `id`
  - `class`
  - `fill`
  - `stroke`
  - `stroke-width`
- 任意属性の追加も可能（キーと値を入力して追加）  
- 属性を削除すると、SVG 文字列からも該当属性が削除される

### 3. ファイル読み込み

- `CustomTextEditorProvider` で SVG テキストを読み込み  
- Webview へ `postMessage` で送信し、Webview 側で `DOMParser` により  
  XML として解析  
- 無効な XML / SVG の場合は、Webview 上にエラーメッセージを表示し、  
  可能な範囲で部分的に表示・編集できるようにする  
  （MVP では単純なエラー表示でもよい）

### 4. ファイル保存

- Webview 内で編集された DOM を `XMLSerializer` で SVG 文字列に変換  
- VS Code 側へ `postMessage` で送信し、`workspace.applyEdit` で保存  
- 保存時の方針:
  - 元のインデント・属性順序などは可能な範囲で保つ  
    （不要な整形は行わない）  
  - BOM や改行コードなどは VS Code の設定に従う

### 5. 通信仕様

#### Webview → 拡張

```json
{ "type": "updateSvg", "svgText": "<svg>...</svg>" }
```

- 編集結果を VS Code 側へ通知する  
- 送信タイミング:
  - 明示的な保存操作（Ctrl+S / Cmd+S）  
  - 必要に応じてオートセーブ時

#### 拡張 → Webview

```json
{ "type": "load", "svgText": "<svg ...>" }
```

- VS Code 側で読み込んだ SVG を Webview に初期データとして渡す  
- 追加のメッセージ種別（例: エラー通知など）は、  
  必要になれば別途定義する

## 技術構成

### VS Code 拡張側

- `package.json`（`contributes.customEditors` の登録）  
- `SvgEditorProvider.ts`（読み書き・メッセージ橋渡し担当）
  - `resolveCustomTextEditor` の実装  
  - Webview への初期データ送信（`type: "load"`）  
  - Webview からの `updateSvg` メッセージ受信とファイル保存処理  
- Webview リソースの提供（`index.html`, バンドル済み JS / CSS）

### Webview 側

- SVG テキストの XML 解析と内部データ構造への変換  
  - DOM API または独自の中間表現  
- レイヤーツリー UI、プレビュー、属性編集 UI の描画  
- DOM から SVG 文字列への serialize 処理  
- VS Code 拡張との `postMessage` / `onDidReceiveMessage` による通信

## 外部ライブラリ

- `panzoom`（ズーム / パン機能）  
- UI 実装用フレームワーク（任意）
  - 例: `React`, `Svelte`, `Lit` など  
  - MVP では 1 つに絞って実装する

## 開発手順（MVP）

1. `yo code` で拡張機能の雛形を作成  
2. `package.json` に custom editor を登録  
3. `SvgEditorProvider.ts` を実装し、SVG テキストの読み込み / 保存を行う  
4. Webview を初期化し、`load` メッセージで SVG を渡せるようにする  
5. Webview 側で SVG をパースし、内部構造を構築する  
6. レイヤーツリー表示を実装する  
7. プレビューと要素選択、ツリーとの選択同期を実装する  
8. 右パネルの属性編集 UI と、DOM への反映処理を実装する  
9. serialize & 保存処理を通して、実ファイルへの反映を確認する  
10. UI / UX の微調整、エラー時のメッセージ表示などを行う


